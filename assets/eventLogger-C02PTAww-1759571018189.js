const i={AGENT_BIRTH:"agent_birth",AGENT_DEATH:"agent_death",RESOURCE_PRODUCTION:"resource_production",STARVATION_WARNING:"starvation_warning",ECONOMIC_BOOM:"economic_boom",ECONOMIC_CRISIS:"economic_crisis",CONNECTION_FORMED:"connection_formed",CONNECTION_BROKEN:"connection_broken",POLARIZATION_EVENT:"polarization_event",CLAN_FORMED:"clan_formed",CLAN_DECISION_MADE:"clan_decision_made",CONFLICT_INITIATED:"conflict_initiated",RESOURCE_THEFT:"resource_theft",CYCLE_COMPLETED:"cycle_completed",MILESTONE_REACHED:"milestone_reached"},o={INFO:"info",CRITICAL:"critical",MILESTONE:"milestone"};class E{constructor(){this.events=[],this.eventCounts={},this.cycleEvents=new Map,this.agentEvents=new Map,this.clanEvents=new Map,this.statistics={totalEvents:0,eventsByType:{},eventsBySeverity:{},eventsPerCycle:[],criticalEvents:[]}}logEvent(t,e={},n=o.INFO){const s={id:this.events.length,type:t,severity:n,timestamp:Date.now(),cycle:e.cycle||0,data:{...e},description:this._generateDescription(t,e)};return this.events.push(s),this._updateStatistics(s),this._categorizeEvent(s),n===o.CRITICAL&&console.warn(`🚨 Critical Event: ${s.description}`),s}_generateDescription(t,e){var n,s;switch(t){case i.AGENT_BIRTH:return`Агент ${e.agentId} родился в кластере ${e.cluster}`;case i.AGENT_DEATH:return`Агент ${e.agentId} умер от ${e.cause||"неизвестной причины"} (ресурсы: ${((n=e.resources)==null?void 0:n.toFixed(2))||0})`;case i.RESOURCE_PRODUCTION:return`Агент ${e.agentId} произвел ${e.amount.toFixed(2)} ресурсов (множитель: ${((s=e.multiplier)==null?void 0:s.toFixed(2))||1})`;case i.STARVATION_WARNING:return`Агент ${e.agentId} голодает ${e.starvationDays} дней (ресурсы: ${e.resources.toFixed(2)})`;case i.ECONOMIC_BOOM:return`Экономический бум! Средние ресурсы: ${e.averageResources.toFixed(2)} (+${e.growthRate.toFixed(1)}%)`;case i.ECONOMIC_CRISIS:return`Экономический кризис! ${e.deathRate.toFixed(1)}% агентов умерло за цикл`;case i.CLAN_FORMED:return`Клан ${e.clanId} сформирован (${e.memberCount} членов, плотность: ${e.density.toFixed(2)})`;case i.CLAN_DECISION_MADE:return`Клан ${e.clanId} выбрал ${e.decision} (голосов: ${e.votes})`;case i.CONFLICT_INITIATED:return`Клан ${e.attackerId} атакует клан ${e.victimId} (сила: ${e.attackerStrength.toFixed(1)} vs ${e.victimStrength.toFixed(1)})`;case i.RESOURCE_THEFT:return`Украдено ${e.amount.toFixed(2)} ресурсов у клана ${e.victimId}`;case i.CONNECTION_FORMED:return`Связь образована между агентами ${e.agent1} и ${e.agent2} (сила: ${e.strength.toFixed(2)})`;case i.POLARIZATION_EVENT:return`Поляризация: ${e.connectionCount} связей ослаблены на ${e.averageWeakening.toFixed(1)}%`;case i.MILESTONE_REACHED:return`Достигнута веха: ${e.milestone} (цикл ${e.cycle})`;default:return`Событие ${t}: ${JSON.stringify(e)}`}}_updateStatistics(t){this.statistics.totalEvents++,this.statistics.eventsByType[t.type]||(this.statistics.eventsByType[t.type]=0),this.statistics.eventsByType[t.type]++,this.statistics.eventsBySeverity[t.severity]||(this.statistics.eventsBySeverity[t.severity]=0),this.statistics.eventsBySeverity[t.severity]++,t.severity===o.CRITICAL&&this.statistics.criticalEvents.push(t);const e=t.cycle;this.statistics.eventsPerCycle[e]||(this.statistics.eventsPerCycle[e]=0),this.statistics.eventsPerCycle[e]++}_categorizeEvent(t){const e=t.cycle;if(this.cycleEvents.has(e)||this.cycleEvents.set(e,[]),this.cycleEvents.get(e).push(t),t.data.agentId!==void 0){const n=t.data.agentId;this.agentEvents.has(n)||this.agentEvents.set(n,[]),this.agentEvents.get(n).push(t)}if(t.data.clanId!==void 0){const n=t.data.clanId;this.clanEvents.has(n)||this.clanEvents.set(n,[]),this.clanEvents.get(n).push(t)}}getEvents(t={}){let e=[...this.events];return t.type&&(e=e.filter(n=>n.type===t.type)),t.severity&&(e=e.filter(n=>n.severity===t.severity)),t.cycle!==void 0&&(e=e.filter(n=>n.cycle===t.cycle)),t.agentId!==void 0&&(e=e.filter(n=>n.data.agentId===t.agentId)),t.clanId!==void 0&&(e=e.filter(n=>n.data.clanId===t.clanId)),t.limit&&(e=e.slice(-t.limit)),e}getEventsByCycle(t){return this.cycleEvents.get(t)||[]}getEventsByAgent(t){return this.agentEvents.get(t)||[]}getEventsByClan(t){return this.clanEvents.get(t)||[]}analyzeTrends(){return{economicHealth:this._analyzeEconomicTrends(),socialStability:this._analyzeSocialTrends(),conflictIntensity:this._analyzeConflictTrends(),populationDynamics:this._analyzePopulationTrends()}}_analyzeEconomicTrends(){const e=this.events.filter(c=>[i.RESOURCE_PRODUCTION,i.ECONOMIC_BOOM,i.ECONOMIC_CRISIS,i.STARVATION_WARNING].includes(c.type)).slice(-20),n=e.filter(c=>c.type===i.ECONOMIC_CRISIS),s=e.filter(c=>c.type===i.ECONOMIC_BOOM);return{trend:s.length>n.length?"positive":"negative",stability:Math.max(0,1-n.length/Math.max(1,e.length)),recentCrises:n.length,recentBooms:s.length}}_analyzeSocialTrends(){const e=this.events.filter(r=>[i.CONNECTION_FORMED,i.CONNECTION_BROKEN,i.POLARIZATION_EVENT].includes(r.type)).slice(-30),n=e.filter(r=>r.type===i.CONNECTION_FORMED),s=e.filter(r=>r.type===i.CONNECTION_BROKEN),c=e.filter(r=>r.type===i.POLARIZATION_EVENT);return{cohesion:n.length/Math.max(1,s.length),polarization:c.length/Math.max(1,e.length),networkGrowth:n.length-s.length}}_analyzeConflictTrends(){const e=this.events.filter(s=>[i.CONFLICT_INITIATED,i.RESOURCE_THEFT].includes(s.type)).slice(-10),n=e.filter(s=>s.type===i.RESOURCE_THEFT).reduce((s,c)=>s+(c.data.amount||0),0);return{frequency:e.length,intensity:n/Math.max(1,e.length),trend:e.length>5?"escalating":"stable"}}_analyzePopulationTrends(){const t=this.events.filter(c=>c.type===i.AGENT_BIRTH),e=this.events.filter(c=>c.type===i.AGENT_DEATH),n=t.slice(-20),s=e.slice(-20);return{birthRate:n.length,deathRate:s.length,netGrowth:n.length-s.length,mortalityCauses:this._analyzeMortalityCauses(s)}}_analyzeMortalityCauses(t){const e={};return t.forEach(n=>{const s=n.data.cause||"unknown";e[s]=(e[s]||0)+1}),e}getStatistics(){return{...this.statistics,trends:this.analyzeTrends(),recentEvents:this.events.slice(-10),eventTimeline:this._generateTimeline()}}_generateTimeline(){const t=[],e={};return this.events.forEach(n=>{const s=n.cycle;e[s]||(e[s]=[]),e[s].push(n)}),Object.keys(e).sort((n,s)=>parseInt(n)-parseInt(s)).forEach(n=>{t.push({cycle:parseInt(n),events:e[n],summary:this._generateCycleSummary(e[n])})}),t}_generateCycleSummary(t){return{total:t.length,critical:t.filter(n=>n.severity===o.CRITICAL).length,economic:t.filter(n=>n.type.includes("resource")||n.type.includes("economic")).length,social:t.filter(n=>n.type.includes("connection")||n.type.includes("clan")).length,conflicts:t.filter(n=>n.type.includes("conflict")).length}}exportEvents(t="json",e={}){const n=this.getEvents(e);switch(t){case"json":return JSON.stringify(n,null,2);case"csv":return this._exportToCSV(n);case"timeline":return this._exportToTimeline(n);default:return n}}_exportToCSV(t){const e=["ID","Type","Severity","Cycle","Timestamp","Description"],n=t.map(s=>[s.id,s.type,s.severity,s.cycle,new Date(s.timestamp).toISOString(),s.description]);return[e,...n].map(s=>s.join(",")).join(`
`)}_exportToTimeline(t){return t.map(e=>({time:new Date(e.timestamp).toISOString(),cycle:e.cycle,event:e.description,severity:e.severity,category:this._categorizeEventType(e.type)}))}_categorizeEventType(t){return t.includes("resource")||t.includes("economic")?"Economic":t.includes("connection")||t.includes("opinion")?"Social":t.includes("clan")?"Clan":t.includes("conflict")?"Conflict":"System"}startCycle(t){this.logEvent(i.CYCLE_COMPLETED,{cycle:t},o.INFO)}logCycleEconomics(t){const{cycle:e=0,survived:n=0,died:s=0,averageResources:c=0,totalProduction:r=0}=t||{};this.logEvent(i.RESOURCE_PRODUCTION,{cycle:e,survived:n,died:s,averageResources:c,totalProduction:r},o.INFO);const l=n+s;l>0&&s>n*.1&&this.logEvent(i.ECONOMIC_CRISIS,{cycle:e,deathRate:s/l*100,died:s,survived:n},o.CRITICAL),c>100&&this.logEvent(i.ECONOMIC_BOOM,{cycle:e,averageResources:c,growthRate:(c-50)/50*100},o.MILESTONE)}clear(){this.events=[],this.eventCounts={},this.cycleEvents.clear(),this.agentEvents.clear(),this.clanEvents.clear(),this.statistics={totalEvents:0,eventsByType:{},eventsBySeverity:{},eventsPerCycle:[],criticalEvents:[]}}}export{o as EVENT_SEVERITY,i as EVENT_TYPES,E as EventLogger,E as default};
